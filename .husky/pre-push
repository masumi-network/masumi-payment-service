#!/usr/bin/env sh

# Portable and safe way to handle colors
if command -v tput >/dev/null 2>&1 && [ -t 1 ]; then
    # We have tput and it's an interactive terminal
    if tput setaf 1 >/dev/null 2>&1; then
        GREEN=$(tput setaf 2)
        RED=$(tput setaf 1)
        BLUE=$(tput setaf 4)
        YELLOW=$(tput setaf 3)
        NC=$(tput sgr0)
    else
        GREEN=""
        RED=""
        BLUE=""
        YELLOW=""
        NC=""
    fi
else
    GREEN=""
    RED=""
    BLUE=""
    YELLOW=""
    NC=""
fi

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "${RED}âŒ Not a git repository${NC}"
    exit 1
fi

# Check if pnpm is available
if ! command -v pnpm >/dev/null 2>&1; then
    echo "${RED}âŒ pnpm is not installed or not in PATH${NC}"
    exit 2
fi

# Protected branches
protected_branches="^(main|dev)$"

# Get the current branch in a cross-platform way
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD)

# Read standard input in a while loop
while IFS= read -r line || [ -n "$line" ]; do
    if [ -z "$line" ]; then
        continue
    fi
    
    # Split the line into components safely
    local_ref=$(echo "$line" | cut -d' ' -f1)
    local_sha=$(echo "$line" | cut -d' ' -f2)
    remote_ref=$(echo "$line" | cut -d' ' -f3)
    remote_sha=$(echo "$line" | cut -d' ' -f4)
    
    # Extract branch name from ref
    remote_branch=${remote_ref##*/}
    
    if echo "$remote_branch" | grep -qE "$protected_branches"; then
        echo "${RED}âŒ Direct push to $remote_branch branch is not allowed${NC}"
        echo "${YELLOW}Please create a pull request instead.${NC}"
        exit 3
    fi
done

# Run Prettier to fix formatting
echo "${BLUE}ğŸ” Running Prettier (format fix)...${NC}"
if ! pnpm run format; then
    echo "${RED}âŒ Prettier formatting failed. Please fix errors and try again.${NC}"
    exit 4
fi

# Run ESLint only on staged files
echo "${BLUE}ğŸ” Running ESLint (full project)...${NC}"
if ! pnpm run lint; then \
(
    echo "${RED}âŒ ESLint check failed. Please fix the errors and try committing again.${NC}"
    exit 5
)

# Generate Swagger JSON
echo "${BLUE}ğŸ” Generating Swagger JSON...${NC}"
if ! pnpm run swagger-json; then
    echo "${RED}âŒ Swagger JSON generation failed. Please fix errors and try again.${NC}"
    exit 6
fi

# Check if OpenAPI JSON file changed
echo "${BLUE}ğŸ” Checking if OpenAPI JSON changed...${NC}"
if git diff --exit-code --quiet -- src/utils/generator/swagger-generator/openapi-docs.json; then
    echo "${GREEN}âœ… OpenAPI JSON unchanged, skipping Postman collection generation${NC}"
else
    echo "${BLUE}ğŸ” OpenAPI JSON changed, generating Postman collection...${NC}"
    if ! pnpm run swagger-postman; then
        echo "${RED}âŒ Postman collection generation failed. Please fix errors and try again.${NC}"
        exit 7
    fi
fi

# Generate types
echo "${BLUE}ğŸ” Generating frontend types...${NC}"
if ! (cd frontend && pnpm run openapi-ts-latest); then
    echo "${RED}âŒ Type generation for the frontend failed. Please fix errors and try again.${NC}"
    exit 8
fi

# Check for changes in generated files
echo "${BLUE}ğŸ” Checking for generated file changes...${NC}"
if git diff --quiet; then
    echo "${GREEN}âœ… No changes in generated files${NC}"
else
    echo "${BLUE}ğŸ“ Committing generated file changes...${NC}"
    git add .
    git commit -m "chore: generate, format and lint" --no-verify
    echo "${GREEN}âœ… Generated files committed${NC}"
fi



echo "${GREEN}âœ… All pre-push checks completed!${NC}" 