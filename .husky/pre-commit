#!/usr/bin/env sh

# Portable and safe way to handle colors
if command -v tput >/dev/null 2>&1 && [ -t 1 ]; then
    # We have tput and it's an interactive terminal
    if tput setaf 1 >/dev/null 2>&1; then
        GREEN=$(tput setaf 2)
        RED=$(tput setaf 1)
        BLUE=$(tput setaf 4)
        NC=$(tput sgr0)
    else
        GREEN=""
        RED=""
        BLUE=""
        NC=""
    fi
else
    GREEN=""
    RED=""
    BLUE=""
    NC=""
fi


# Check if npm is available
if ! command -v npm >/dev/null 2>&1; then
    echo "${RED}âŒ npm is not installed or not in PATH${NC}"
    exit 3
fi


# Run ESLint only on staged files
echo "${BLUE}ğŸ” Running format on staged files...${NC}"
if command -v git >/dev/null 2>&1 && git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    staged_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.ts' '*.js' '*.tsx' '*.jsx' 2>/dev/null)
    if [ -n "$staged_files" ]; then
        echo "$staged_files" | tr '\n' '\0' | xargs -0 npm run format -- || 
        (
            echo "${RED}âŒ Formatting failed. Please fix the errors and try committing again.${NC}"
            exit 5
        )
    fi
fi


echo "${GREEN}âœ… All checks passed!${NC}"
# Only run lint-staged if it exists in package.json and npx is available
if command -v npx >/dev/null 2>&1 && grep -q "\"lint-staged\"" package.json 2>/dev/null; then
    npx --no -- lint-staged
fi