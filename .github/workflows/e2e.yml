name: E2E Tests

on:
  pull_request:
    branches: [dev]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Create Neon Database Branch
        id: create-branch
        run: |
          BRANCH_NAME="e2e-ci-pr-${{ github.event.pull_request.number }}-run-${{ github.run_id }}"
          EXPIRES_AT="$(date -u -d '+24 hours' +'%Y-%m-%dT%H:%M:%SZ')"
          echo "Creating database branch: $BRANCH_NAME"
          echo "Branch will expire at (UTC): $EXPIRES_AT"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://console.neon.tech/api/v2/projects/${{ secrets.NEON_PROJECT_ID }}/branches" \
            -H "Authorization: Bearer ${{ secrets.NEON_API_KEY }}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d "{
              \"endpoints\": [
                {
                  \"type\": \"read_write\"
                }
              ],
              \"branch\": {
                \"name\": \"$BRANCH_NAME\",
                \"expires_at\": \"$EXPIRES_AT\"
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "201" ]; then
            echo "❌ Failed to create branch. HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

          BRANCH_ID=$(echo $BODY | jq -r '.branch.id')
          ENDPOINT_HOST=$(echo $BODY | jq -r '.endpoints[0].host')

          if [ "$BRANCH_ID" = "null" ] || [ -z "$BRANCH_ID" ]; then
            echo "❌ Failed to extract branch ID from response"
            exit 1
          fi

          BASE_URI="${{ secrets.DATABASE_URL }}"
          CONNECTION_URI=$(echo $BASE_URI | sed "s/@[^/]*/@$ENDPOINT_HOST/")

          echo "branch_id=$BRANCH_ID" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "connection_uri=$CONNECTION_URI" >> $GITHUB_OUTPUT
          echo "endpoint_host=$ENDPOINT_HOST" >> $GITHUB_OUTPUT

          echo "✅ Database branch created: $BRANCH_NAME"
          echo "✅ Branch ID: $BRANCH_ID"
          echo "✅ Endpoint: $ENDPOINT_HOST"

      - name: Wait for Branch to be Ready
        run: |
          echo "Waiting for branch to be ready..."
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s \
              "https://console.neon.tech/api/v2/projects/${{ secrets.NEON_PROJECT_ID }}/branches/${{ steps.create-branch.outputs.branch_id }}" \
              -H "Authorization: Bearer ${{ secrets.NEON_API_KEY }}" \
              -H "Accept: application/json")
            
            STATUS=$(echo $RESPONSE | jq -r '.branch.current_state')
            
            if [ "$STATUS" = "ready" ]; then
              echo "✅ Branch is ready!"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Branch state is '$STATUS', waiting 5 seconds..."
            sleep 5
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "❌ Branch failed to become ready within timeout (5 minutes)"
            echo "Last known state: $STATUS"
            exit 1
          fi

      - name: Generate Prisma Client
        run: pnpm run prisma:generate
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.connection_uri }}

      - name: Run Database Migrations
        run: pnpm exec prisma migrate deploy --config prisma/prisma.config.ts
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.connection_uri }}

      - name: Seed Database
        run: pnpm exec prisma db seed --config prisma/prisma.config.ts
        env:
          DATABASE_URL: "${{ steps.create-branch.outputs.connection_uri }}"
          PURCHASE_WALLET_PREPROD_MNEMONIC: "${{ secrets.PURCHASE_WALLET_PREPROD_MNEMONIC }}"
          SELLING_WALLET_PREPROD_MNEMONIC: "${{ secrets.SELLING_WALLET_PREPROD_MNEMONIC }}"
          BLOCKFROST_API_KEY_PREPROD: "${{ secrets.BLOCKFROST_API_KEY_PREPROD }}"
          ENCRYPTION_KEY: "${{ secrets.ENCRYPTION_KEY }}"
          ADMIN_KEY: "${{ secrets.ADMIN_KEY }}"

      - name: Start API Server
        run: |
          echo "Starting API server..."
          npx tsx ./src/index.ts > server.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          echo "$SERVER_PID" > server.pid

        env:
          DATABASE_URL: "${{ steps.create-branch.outputs.connection_uri }}"
          ENCRYPTION_KEY: "${{ secrets.ENCRYPTION_KEY }}"
          NODE_ENV: "test"
          PORT: 3001

      - name: Wait for Server Ready
        run: |
          echo "Waiting for server to start..."
          # Continuously poll health endpoint until ready or timeout
          npx wait-on http://127.0.0.1:3001/api/v1/health -t 180000 --interval 2000 || {
            echo "=== Server failed to become healthy ==="
            if [ -f server.pid ]; then
              echo "Process status:"
              ps -p "$(cat server.pid)" -o pid,cmd || true
            fi
            echo "=== Full server log ==="
            cat server.log
            exit 1
          }
          echo "=== Server is responding, recent log tail ==="
          tail -50 server.log || true

      - name: Run E2E Test Suite
        run: pnpm run test:e2e
        env:
          TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
          TEST_API_URL: http://127.0.0.1:3001
          TEST_NETWORK: Preprod
          TEST_TIMEOUT_REGISTRATION: 1800000
          DATABASE_URL: ${{ steps.create-branch.outputs.connection_uri }}
          BLOCKFROST_API_KEY_PREPROD: ${{ secrets.BLOCKFROST_API_KEY_PREPROD }}

      - name: Stop API Server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
