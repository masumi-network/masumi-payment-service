name: E2E Tests

on:
  pull_request:
    branches: [dev]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Create Neon Database Branch
        id: create-branch
        run: |
          BRANCH_NAME="pr-${{ github.event.pull_request.number }}-${{ github.run_id }}"
          echo "Creating database branch: $BRANCH_NAME"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://console.neon.tech/api/v2/projects/${{ secrets.NEON_PROJECT_ID }}/branches" \
            -H "Authorization: Bearer ${{ secrets.NEON_API_KEY }}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d "{
              \"endpoints\": [
                {
                  \"type\": \"read_write\"
                }
              ],
              \"branch\": {
                \"name\": \"$BRANCH_NAME\"
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "201" ]; then
            echo "❌ Failed to create branch. HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

          BRANCH_ID=$(echo $BODY | jq -r '.branch.id')
          ENDPOINT_HOST=$(echo $BODY | jq -r '.endpoints[0].host')

          if [ "$BRANCH_ID" = "null" ] || [ -z "$BRANCH_ID" ]; then
            echo "❌ Failed to extract branch ID from response"
            exit 1
          fi

          BASE_URI="${{ secrets.DATABASE_URL }}"
          CONNECTION_URI=$(echo $BASE_URI | sed "s/@[^/]*/@$ENDPOINT_HOST/")

          echo "branch_id=$BRANCH_ID" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "connection_uri=$CONNECTION_URI" >> $GITHUB_OUTPUT
          echo "endpoint_host=$ENDPOINT_HOST" >> $GITHUB_OUTPUT

          echo "✅ Database branch created: $BRANCH_NAME"
          echo "✅ Branch ID: $BRANCH_ID"
          echo "✅ Endpoint: $ENDPOINT_HOST"

      - name: Wait for Branch to be Ready
        run: |
          echo "Waiting for branch to be ready..."
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s \
              "https://console.neon.tech/api/v2/projects/${{ secrets.NEON_PROJECT_ID }}/branches/${{ steps.create-branch.outputs.branch_id }}" \
              -H "Authorization: Bearer ${{ secrets.NEON_API_KEY }}" \
              -H "Accept: application/json")
            
            STATUS=$(echo $RESPONSE | jq -r '.branch.current_state')
            
            if [ "$STATUS" = "ready" ]; then
              echo "✅ Branch is ready!"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Branch state is '$STATUS', waiting 5 seconds..."
            sleep 5
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "❌ Branch failed to become ready within timeout (5 minutes)"
            echo "Last known state: $STATUS"
            exit 1
          fi

      - name: Generate Prisma Client
        run: npm run prisma:generate
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.connection_uri }}

      - name: Run Database Migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.connection_uri }}

      - name: Seed Database
        run: npx cross-env DATABASE_URL="${{ steps.create-branch.outputs.connection_uri }}"" PURCHASE_WALLET_PREPROD_MNEMONIC="${{ secrets.PURCHASE_WALLET_PREPROD_MNEMONIC }}" SELLING_WALLET_PREPROD_MNEMONIC="${{ secrets.SELLING_WALLET_PREPROD_MNEMONIC }}" BLOCKFROST_API_KEY_PREPROD="${{ secrets.BLOCKFROST_API_KEY_PREPROD }}" ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}" prisma db seed
        env:
          DATABASE_URL: "${{ steps.create-branch.outputs.connection_uri }}"
          PURCHASE_WALLET_PREPROD_MNEMONIC: "${{ secrets.PURCHASE_WALLET_PREPROD_MNEMONIC }}"
          SELLING_WALLET_PREPROD_MNEMONIC: "${{ secrets.SELLING_WALLET_PREPROD_MNEMONIC }}"
          BLOCKFROST_API_KEY_PREPROD: "${{ secrets.BLOCKFROST_API_KEY_PREPROD }}"
          ENCRYPTION_KEY: "${{ secrets.ENCRYPTION_KEY }}"

      - name: Start API Server
        run: |
          echo "Starting API server..."
          npx cross-env DATABASE_URL="${{ steps.create-branch.outputs.connection_uri }}" ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}" NODE_ENV="test" PORT=3001 tsx watch ./src/index.ts > server.log 2>&1 &

      - name: Wait for Server Ready
        run: |
          echo "Waiting for server to start..."
          sleep 55
          echo "=== Server Log (first 50 lines) ==="
          head -50 server.log || echo "No server log yet"
          echo "=== Checking if server is running ==="
          npx wait-on http://localhost:3001/api/v1/health -t 120000 || {
            echo "=== Server failed to start. Full server log: ==="
            cat server.log
            exit 1
          }

      - name: Run E2E Test Suite
        run: npm run test:e2e -- --runInBand --bail
        env:
          TEST_API_KEY: ${{ secrets.TEST_API_KEY }}
          TEST_API_URL: http://localhost:3001
          TEST_NETWORK: Preprod
          TEST_TIMEOUT_REGISTRATION: 1800000
          DATABASE_URL: ${{ steps.create-branch.outputs.connection_uri }}
          BLOCKFROST_API_KEY_PREPROD: ${{ secrets.BLOCKFROST_API_KEY_PREPROD }}

      - name: Stop API Server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Upload Server Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-logs
          path: |
            server.log
            **/*.log
          retention-days: 7

      - name: Delete Neon Database Branch
        if: always()
        run: |
          echo "Deleting database branch: ${{ steps.create-branch.outputs.branch_name }}"
          curl -X DELETE \
            "https://console.neon.tech/api/v2/projects/${{ secrets.NEON_PROJECT_ID }}/branches/${{ steps.create-branch.outputs.branch_id }}" \
            -H "Authorization: Bearer ${{ secrets.NEON_API_KEY }}" \
            -H "Accept: application/json"
          echo "✅ Database branch deleted"
